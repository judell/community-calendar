name: Generate Calendar

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      locations:
        description: 'Locations to process (comma-separated: santarosa,bloomington,davis,petaluma or "all")'
        required: false
        default: 'all'
      regenerate_only:
        description: 'Skip scraping, only regenerate from existing local ICS files'
        required: false
        type: boolean
        default: false
      months:
        description: 'Number of months ahead to scrape (default: 6)'
        required: false
        default: '6'
  schedule:
    - cron: '0 0 * * *'

jobs:
  generate-calendar:
    runs-on: ubuntu-latest
    env:
      SCRAPE_MONTHS: ${{ github.event.inputs.months || '6' }}

    steps:
    - name: Check out repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libxml2-dev libxslt-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Node dependencies (for Puppeteer)
      run: |
        npm install puppeteer-extra puppeteer-extra-plugin-stealth
        npx puppeteer browsers install chrome

    - name: Determine locations to process
      id: locations
      run: |
        INPUT="${{ github.event.inputs.locations }}"
        if [ -z "$INPUT" ] || [ "$INPUT" = "all" ]; then
          echo "list=santarosa,bloomington,davis,petaluma,toronto" >> $GITHUB_OUTPUT
        else
          echo "list=$INPUT" >> $GITHUB_OUTPUT
        fi

    # ==========================================
    # Santa Rosa
    # ==========================================
    - name: Scrape Santa Rosa sources
      if: contains(steps.locations.outputs.list, 'santarosa') && github.event.inputs.regenerate_only != 'true'
      run: |
        echo "Scraping Santa Rosa..."
        python scripts/library_intercept.py --location santarosa --output cities/santarosa/library_intercept.ics || true
        python scrapers/cityspark/bohemian.py --output cities/santarosa/bohemian.ics || true
        python scrapers/cityspark/pressdemocrat.py --output cities/santarosa/pressdemocrat.ics || true
        python scrapers/sonoma_parks.py --output cities/santarosa/sonoma_parks.ics || true
        python scrapers/cal_theatre.py --output cities/santarosa/cal_theatre.ics || true
        python scrapers/copperfields.py --output cities/santarosa/copperfields.ics || true
        python scrapers/sonoma_county_gov.py --output cities/santarosa/sonoma_county_gov.ics || true
        python scrapers/wix/cafefrida.py --output cities/santarosa/cafefrida.ics || true
        python scrapers/srcc.py --output cities/santarosa/srcc.ics || true
        python scrapers/barrel_proof.py --output cities/santarosa/barrel_proof.ics || true
        python scrapers/sportsbasement.py --location "Santa Rosa" --output cities/santarosa/sportsbasement.ics || true
        python scrapers/sebarts.py --output cities/santarosa/sebarts.ics || true
        python scrapers/legistar.py --client santa-rosa --source "City of Santa Rosa Legistar" -o cities/santarosa/legistar.ics || true
        
        echo "\n=== Santa Rosa Scraper Results ==="
        for f in cities/santarosa/*.ics; do
          if [ -f "$f" ]; then
            events=$(grep -c 'BEGIN:VEVENT' "$f" 2>/dev/null || echo 0)
            size=$(stat -f%z "$f" 2>/dev/null || stat -c%s "$f" 2>/dev/null || echo 0)
            name=$(basename "$f")
            if [ "$events" -gt 0 ]; then
              echo "  ✅ $name: $events events"
            elif [ "$size" -gt 100 ]; then
              echo "  ⚠️ $name: no events (but file exists)"
            else
              echo "  ❌ $name: empty or missing"
            fi
          fi
        done
      continue-on-error: true

    - name: Download Santa Rosa live feeds and combine ICS
      if: contains(steps.locations.outputs.list, 'santarosa')
      run: |
        cd cities/santarosa
        curl -sL "https://calendar.google.com/calendar/ical/eventsatarlenefransictheater@gmail.com/public/basic.ics" -o arlene_francis_theater.ics || true
        curl -sL "https://lutherburbankcenter.org/events/?ical=1" -o luther_burbank_center.ics || true
        curl -sL "https://schulzmuseum.org/events/?ical=1" -o schulz_museum.ics || true
        curl -sL "https://www.sonoma.com/events/?ical=1" -o sonoma_com.ics || true
        curl -sL "https://golocal.coop/?post_type=tribe_events&ical=1&eventDisplay=list" -o golocal_coop.ics || true
        curl -sL "https://sonomacountyaa.org/events/?ical=1" -o sonoma_county_aa.ics || true
        curl -sL "https://calendar.google.com/calendar/ical/dsasonomacounty%40gmail.com/public/basic.ics" -o sonoma_county_dsa.ics || true
        # Meetup groups
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/sonoma-county-go-wild-hikers/events/ical/" -o meetup_go_wild_hikers.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/shutupandwritewinecountry/events/ical/" -o meetup_shutupandwrite.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/scottish-country-dancing/events/ical/" -o meetup_scottish_dancing.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/sonoma-county-womens-wine-club/events/ical/" -o meetup_womens_wine_club.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/santa-rosa-toastmasters-public-speaking-meetup-group/events/ical/" -o meetup_toastmasters.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/nataraja-school-of-traditional-yoga/events/ical/" -o meetup_yoga.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/santa-rosa-womens-creativity-collective/events/ical/" -o meetup_creativity.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/sonoma-county-boomers/events/ical/" -o meetup_boomers.ics || true
        cd ../..
        # Eventbrite scrape
        python scrapers/eventbrite_scraper.py --location ca--santa-rosa --months ${SCRAPE_MONTHS:-2} > cities/santarosa/eventbrite.ics || true
        python scripts/combine_ics.py --input-dir cities/santarosa --output cities/santarosa/combined.ics --name "Santa Rosa Community Calendar"

    # ==========================================
    # Bloomington
    # ==========================================
    - name: Scrape Bloomington sources
      if: contains(steps.locations.outputs.list, 'bloomington') && github.event.inputs.regenerate_only != 'true'
      run: |
        echo "Scraping Bloomington..."
        python scripts/library_intercept.py --location bloomington --output cities/bloomington/library_intercept.ics || true
      continue-on-error: true

    - name: Download Bloomington live feeds and combine ICS
      if: contains(steps.locations.outputs.list, 'bloomington')
      run: |
        cd cities/bloomington
        curl -sL "https://bgcbloomington.org/events/list/?ical=1" -o bgc_bloomington.ics || true
        curl -sL "https://calendar.google.com/calendar/ical/bloomington.in.gov_1b95au4d2ueudldosb024fimp0@group.calendar.google.com/public/basic.ics" -o bloomington_gov.ics || true
        curl -sL "https://tockify.com/api/feeds/ics/bloomington.arts.calendar" -o bloomington_arts.ics || true
        # IU LiveWhale feeds
        curl -sL "https://events.iu.edu/live/ical/events/group_id/56" -o iu_jacobs_music.ics || true
        curl -sL "https://events.iu.edu/live/ical/events/group_id/378" -o iu_auditorium.ics || true
        curl -sL "https://events.iu.edu/live/ical/events/group_id/234" -o iu_eskenazi_museum.ics || true
        # B-Square Bulletin Google Calendars
        curl -sL "https://calendar.google.com/calendar/ical/bloomington.in.gov_35a6qiaiperdn7b1r6v2ksjlig@group.calendar.google.com/public/basic.ics" -o bsquare_government.ics || true
        curl -sL "https://calendar.google.com/calendar/ical/4dj0guhji982ca5k90ljeliul0@group.calendar.google.com/public/basic.ics" -o bsquare_misc_civic.ics || true
        curl -sL "https://calendar.google.com/calendar/ical/2gd73d7gc46mstrdnr6k7v7b2o@group.calendar.google.com/public/basic.ics" -o bsquare_critical_mass.ics || true
        curl -sL "https://calendar.google.com/calendar/ical/c_02o6fd3erhdmhe4oc5so149ir0@group.calendar.google.com/public/basic.ics" -o bsquare_bptc.ics || true
        cd ../..
        python scripts/combine_ics.py --input-dir cities/bloomington --output cities/bloomington/combined.ics --name "Bloomington Community Calendar"

    # ==========================================
    # Davis
    # ==========================================
    - name: Scrape Davis sources
      if: contains(steps.locations.outputs.list, 'davis') && github.event.inputs.regenerate_only != 'true'
      run: |
        echo "Scraping Davis..."
        python scrapers/ucdavis_arts.py --output cities/davis/ucdavis_arts.ics || true
        python scrapers/ucdavis_library.py --output cities/davis/ucdavis_library.ics || true
        python scrapers/ucdavis_campusgroups.py --output cities/davis/ucdavis_campusgroups.ics || true
        python scrapers/davis_downtown.py --output cities/davis/davis_downtown.ics || true
        python scrapers/yolo_library.py --output cities/davis/yolo_library.ics || true
        python scrapers/uudavis.py --output cities/davis/uudavis.ics || true
        python cities/davis/scrapers/mondavi_center.py --output cities/davis/mondavi_center.ics || true
        python scrapers/davis_chamber.py --output cities/davis/davis_chamber.ics || true
        python scrapers/ucdavis_athletics.py --output cities/davis/ucdavis_athletics.ics || true
      continue-on-error: true

    - name: Download Davis Meetup feeds and Eventbrite
      if: contains(steps.locations.outputs.list, 'davis')
      run: |
        cd cities/davis
        # Meetup groups
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/mosaics/events/ical/" -o meetup_mosaics.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/intercultural-mosaics/events/ical/" -o meetup_intercultural.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/yolo-county-board-game-gathering/events/ical/" -o meetup_board_games.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/pence-adult-art-programs/events/ical/" -o meetup_pence_art.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/art-in-action/events/ical/" -o meetup_art_in_action.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/mindful-embodied-spirituality/events/ical/" -o meetup_mindful.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/winters-shut-up-and-write-meetup-group/events/ical/" -o meetup_winters_write.ics || true
        cd ../..
        # Eventbrite scrape
        python scrapers/eventbrite_scraper.py --location ca--davis --months ${SCRAPE_MONTHS:-2} --cities davis woodland dixon winters "west sacramento" > cities/davis/eventbrite.ics || true

    - name: Combine Davis ICS
      if: contains(steps.locations.outputs.list, 'davis')
      run: |
        python scripts/combine_ics.py --input-dir cities/davis --output cities/davis/combined.ics --name "Davis Community Calendar"

    # ==========================================
    # Petaluma
    # ==========================================
    - name: Scrape Petaluma sources
      if: contains(steps.locations.outputs.list, 'petaluma') && github.event.inputs.regenerate_only != 'true'
      run: |
        echo "Scraping Petaluma..."
        python scripts/library_intercept.py --location petaluma --output cities/petaluma/library_intercept.ics || true
        python scrapers/mystic_theatre.py --output cities/petaluma/mystic_theatre.ics || true
        # High school athletics
        python scrapers/maxpreps.py --school petaluma-trojans --output cities/petaluma/maxpreps_petaluma_high.ics || true
        python scrapers/maxpreps.py --school casa-grande-gauchos --output cities/petaluma/maxpreps_casa_grande.ics || true
        # Petaluma Chamber of Commerce (GrowthZone)
        python scrapers/growthzone.py --site petalumachamber --output cities/petaluma/petaluma_chamber.ics || true
        python scrapers/srjc_petaluma.py --output cities/petaluma/srjc_petaluma.ics || true
        # HenHouse Brewing and Phoenix Theater
        python scrapers/henhouse.py > cities/petaluma/henhouse.ics || true
        python scrapers/phoenix_theater.py --output cities/petaluma/phoenix_theater.ics || true
        # Mercury Theater and Adobe Road Winery
        python scrapers/mercury_theater.py --output cities/petaluma/mercury_theater.ics || true
        python scrapers/adobe_road.py --output cities/petaluma/adobe_road.ics || true
        # Squarespace venues
        python scrapers/petaluma_arts_center.py --output cities/petaluma/petaluma_arts_center.ics || true
        python scrapers/brewsters.py --output cities/petaluma/brewsters.ics || true
        python scrapers/cool_petaluma.py --output cities/petaluma/cool_petaluma.ics || true
      continue-on-error: true

    - name: Download Petaluma live feeds and combine ICS
      if: contains(steps.locations.outputs.list, 'petaluma')
      run: |
        cd cities/petaluma
        # Tockify feeds
        curl -sL "https://tockify.com/api/feeds/ics/pdaevents" -o petaluma_downtown.ics || true
        # Aqus Community (MembershipWorks)
        curl -sL "https://api.membershipworks.com/v2/events?_op=ics&org=15499" -o aqus_community.ics || true
        # Meetup groups
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/mindfulnesspetaluma/events/ical/" -o meetup_mindful_petaluma.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/the-rebel-craft-collective/events/ical/" -o meetup_rebel_craft.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/meetup-group-bwkyqavs/events/ical/" -o meetup_candlelight_yoga.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/petaluma-figure-drawing-meetup-group/events/ical/" -o meetup_figure_drawing.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/sonoma-marin-brat-pack/events/ical/" -o meetup_brat_pack.ics || true
        # Additional Meetup groups
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/petaluma-salon/events/ical/" -o meetup_petaluma_salon.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/petaluma-book-and-brew-club/events/ical/" -o meetup_book_brew.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/petaluma-active-20-30/events/ical/" -o meetup_active_20_30.ics || true
        # Regional Meetup groups with Petaluma events
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/sonoma-county-outdoors/events/ical/" -o meetup_sonoma_outdoors.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/north-bay-contra-dance/events/ical/" -o meetup_contra_dance.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/sonoma-county-boomers/events/ical/" -o meetup_sonoma_boomers.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/sonoma-county-go-wild-hikers/events/ical/" -o meetup_go_wild_hikers.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/meditate-with-a-monk-in-sonoma-county/events/ical/" -o meetup_meditate_monk.ics || true
        # Hiking & Outdoors Meetup groups (discovered 2026-02-14)
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/northbayhiking/events/ical/" -o meetup_north_bay_adventure.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/north-bay-tails-and-trails/events/ical/" -o meetup_tails_trails.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/meetup-group-qXYJpXNx/events/ical/" -o meetup_north_bay_50plus.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/senior-walkabouters/events/ical/" -o meetup_senior_walkabouters.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/sonoma-county-wanderers/events/ical/" -o meetup_sonoma_wanderers.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/meetup-group-ohazunav/events/ical/" -o meetup_mindfull_hikes.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/Four-Corners-Hiking-Beer/events/ical/" -o meetup_four_corners.ics || true
        # The Big Easy (WordPress + The Events Calendar iCal feed)
        curl -sL "https://bigeasypetaluma.com/events/?ical=1" -o bigeasy.ics || true
        # Polly Klaas Community Theater (WordPress + The Events Calendar iCal feed)
        curl -sL "https://pollyklaastheater.org/events/?ical=1" -o polly_klaas.ics || true
        # Brooks Note Winery (public Google Calendar ICS feed)
        curl -sL "https://calendar.google.com/calendar/ical/c_69dcaa6c13b06c1111a1706565ebb272c3d24290c650a9378bdbd37bff886879%40group.calendar.google.com/public/basic.ics" -o brooksnote.ics || true
        # McNear's Saloon (WordPress + The Events Calendar iCal feed)
        curl -sL "https://www.mcnears.com/event/?ical=1" -o mcnears.ics || true
        # Griffo Distillery (Tockify ICS feed)
        curl -sL "https://tockify.com/api/feeds/ics/tom.l" -o griffo.ics || true
        # Petaluma Elks Lodge (public Google Calendar ICS feed)
        curl -sL "https://calendar.google.com/calendar/ical/elks0901%40gmail.com/public/basic.ics" -o elks_lodge.ics || true
        # Petaluma Garden Club (public Google Calendar ICS feed)
        curl -sL "https://calendar.google.com/calendar/ical/petalumagardenclub%40gmail.com/public/basic.ics" -o garden_club.ics || true
        # Petaluma Bounty (WordPress Events Manager iCal feed)
        curl -sL "https://petalumabounty.org/events-calendar/?ical=1" -o petaluma_bounty.ics || true
        cd ../..
        # Eventbrite scrape
        python scrapers/eventbrite_scraper.py --location ca--petaluma --months ${SCRAPE_MONTHS:-2} > cities/petaluma/eventbrite.ics || true
        python scripts/combine_ics.py --input-dir cities/petaluma --output cities/petaluma/combined.ics --name "Petaluma Community Calendar"

    # ==========================================
    # Toronto
    # ==========================================
    - name: Download Toronto live feeds and combine ICS
      if: contains(steps.locations.outputs.list, 'toronto')
      run: |
        cd cities/toronto
        # Aggregators
        curl -sL "https://nowtoronto.com/events/?ical=1" -o now_toronto.ics || true
        curl -sL "https://tockify.com/api/feeds/ics/torevent" -o torevent.ics || true
        # Music Venues
        curl -sL "https://jazzbistro.ca/events/?ical=1" -o jazz_bistro.ics || true
        curl -sL "https://grossmanstavern.com/events/?ical=1" -o grossmans_tavern.ics || true
        # Venues & Institutions
        curl -sL "https://torontounion.ca/toronto-union-events/?ical=1" -o union_station.ics || true
        curl -sL "https://tockify.com/api/feeds/ics/distilleryevents" -o distillery_events.ics || true
        curl -sL "https://www.gardinermuseum.on.ca/events/?ical=1" -o gardiner_museum.ics || true
        curl -sL "https://www.torontobotanicalgarden.ca/events/?ical=1" -o toronto_botanical.ics || true
        curl -sL "https://www.textilemuseum.ca/events/?ical=1" -o textile_museum.ics || true
        curl -sL "https://batashoemuseum.ca/events/?ical=1" -o bata_shoe_museum.ics || true
        curl -sL "https://www.buddiesinbadtimes.com/events/?ical=1" -o buddies_theatre.ics || true
        curl -sL "https://www.factorytheatre.ca/events/?ical=1" -o factory_theatre.ics || true
        curl -sL "https://highparknaturecentre.com/events/?ical=1" -o high_park_nature.ics || true
        # Universities
        curl -sL "https://events.yorku.ca/events/?mec-ical-feed=1" -o york_university.ics || true
        python ../../scrapers/uoft_events.py -o uoft_events.ics || true
        curl -sL "https://www.engineering.utoronto.ca/engineering-events/?ical=1" -o uoft_engineering.ics || true
        curl -sL "https://philosophy.utoronto.ca/events/?ical=1" -o uoft_philosophy.ics || true
        curl -sL "https://socialwork.utoronto.ca/events/?ical=1" -o uoft_socialwork.ics || true
        # Community Organizations
        curl -sL "https://www.culturelink.ca/events/?ical=1" -o culturelink.ics || true
        curl -sL "https://scaddingcourt.org/events/?ical=1" -o scadding_court.ics || true
        curl -sL "https://tockify.com/api/feeds/ics/st.lawrence.na" -o st_lawrence_na.ics || true
        curl -sL "https://www.bloorwestvillagebia.com/events/?ical=1" -o bloor_west_village.ics || true
        curl -sL "https://tockify.com/api/feeds/ics/jamaalmyers" -o jamaalmyers.ics || true
        # Meetup groups
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/torontobabel/events/ical/" -o meetup_torontobabel.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/torontotnt/events/ical/" -o meetup_try_new_things.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/toronto-arts-and-culture/events/ical/" -o meetup_arts_culture.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/these-boots-are-made-for-hiking/events/ical/" -o meetup_hiking_boots.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/torontobikemeetup/events/ical/" -o meetup_bike_toronto.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/boardgamestoronto/events/ical/" -o meetup_board_games_to.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/salsa-bachata-kizomba-gta/events/ical/" -o meetup_salsa_gta.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/toronto-photography-group/events/ical/" -o meetup_photography_to.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/a-book-club-downtown-abcd/events/ical/" -o meetup_book_club_abcd.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/comedy-improv-and-acting/events/ical/" -o meetup_improv_to.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/techto/events/ical/" -o meetup_techto.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/torontojs/events/ical/" -o meetup_torontojs.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/python-toronto/events/ical/" -o meetup_python_to.ics || true
        cd ../..
        python scripts/combine_ics.py --input-dir cities/toronto --output cities/toronto/combined.ics --name "Toronto Community Calendar"

    # ==========================================
    # Post-processing (all cities)
    # ==========================================
    - name: Convert ICS to JSON for Supabase
      run: |
        IFS=',' read -ra CITIES <<< "${{ steps.locations.outputs.list }}"
        echo "Processing cities: ${CITIES[*]}"
        for city in "${CITIES[@]}"; do
          # Trim whitespace from city name
          city=$(echo "$city" | xargs)
          echo "Checking city: '$city'"
          if [ -f "cities/$city/combined.ics" ]; then
            echo "Running ics_to_json for $city..."
            python scripts/ics_to_json.py "cities/$city/combined.ics" -o "cities/$city/events.json" --city "$city"
            echo "$city: Converted $(cat cities/$city/events.json | python -c 'import json,sys; print(len(json.load(sys.stdin)))') events to JSON"
          else
            echo "WARNING: cities/$city/combined.ics not found!"
          fi
        done

    - name: Generate feed health report
      run: |
        python scripts/report.py --cities ${{ steps.locations.outputs.list }}

    - name: Validate pipeline output
      run: |
        python scripts/validate_pipeline.py --cities ${{ steps.locations.outputs.list }}

    - name: Commit and push if changes
      env:
        GITHUB_TOKEN: ${{ secrets.COMMUNITY_CALENDAR }}
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
        
        # Save generated files before any git operations
        for city in santarosa bloomington davis petaluma toronto; do
          if [ -f "cities/$city/events.json" ]; then
            cp "cities/$city/events.json" "/tmp/${city}_events.json"
          fi
        done
        
        git add .
        git diff --quiet && git diff --staged --quiet || (
          git commit -m "Auto-generate calendar"
          for i in 1 2 3; do
            if git pull --rebase && git push; then
              break
            fi
            echo "Push failed, restoring generated files and retrying..."
            # Restore generated files that may have been clobbered by rebase
            for city in santarosa bloomington davis petaluma toronto; do
              if [ -f "/tmp/${city}_events.json" ]; then
                cp "/tmp/${city}_events.json" "cities/$city/events.json"
              fi
            done
            git add .
            git diff --staged --quiet || git commit --amend --no-edit
            sleep 5
          done
        )

    - name: Wait for GitHub Pages to update
      run: |
        echo "Waiting for GitHub Pages to update..."
        sleep 120  # Wait 2 minutes for GitHub Pages cache to update

        # Verify at least one JSON file is accessible
        for i in 1 2 3; do
          if curl -sL "https://judell.github.io/community-calendar/cities/santarosa/events.json" | head -c 100 | grep -q '"title"'; then
            echo "GitHub Pages is serving updated content"
            break
          fi
          echo "Waiting for GitHub Pages (attempt $i)..."
          sleep 30
        done

    - name: Trigger Supabase events reload
      env:
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      run: |
        echo "Triggering Supabase Edge Function to reload events..."
        RESPONSE=$(curl -sL -X POST 'https://dzpdualvwspgqghrysyz.supabase.co/functions/v1/load-events' \
          -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
          -H 'Content-Type: application/json')
        echo "$RESPONSE" | jq .

        # Check for success
        SUCCESS=$(echo "$RESPONSE" | jq -r '.success // false')
        if [ "$SUCCESS" = "true" ]; then
          INSERTED=$(echo "$RESPONSE" | jq -r '.inserted')
          echo "Successfully loaded $INSERTED events into Supabase"
        else
          echo "Failed to load events"
          echo "$RESPONSE"
          exit 1
        fi
