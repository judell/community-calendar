name: Generate Calendar

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      locations:
        description: 'Locations to process (comma-separated: santarosa,sebastopol,bloomington or "all")'
        required: false
        default: 'all'
      regenerate_only:
        description: 'Skip scraping, only regenerate from existing local ICS files'
        required: false
        type: boolean
        default: false
      months:
        description: 'Number of months ahead to scrape (default: 6)'
        required: false
        default: '6'
  schedule:
    - cron: '0 0 * * *'

jobs:
  generate-calendar:
    runs-on: ubuntu-latest
    env:
      SCRAPE_MONTHS: ${{ github.event.inputs.months || '6' }}

    steps:
    - name: Check out repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libxml2-dev libxslt-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Node dependencies (for Puppeteer)
      run: |
        npm install puppeteer-extra puppeteer-extra-plugin-stealth
        npx puppeteer browsers install chrome

    - name: Determine locations to process
      id: locations
      run: |
        INPUT="${{ github.event.inputs.locations }}"
        if [ -z "$INPUT" ] || [ "$INPUT" = "all" ]; then
          echo "list=santarosa,sebastopol,cotati,sonoma,bloomington,davis" >> $GITHUB_OUTPUT
        else
          echo "list=$INPUT" >> $GITHUB_OUTPUT
        fi

    # ==========================================
    # Santa Rosa
    # ==========================================
    - name: Scrape Santa Rosa sources
      if: contains(steps.locations.outputs.list, 'santarosa') && github.event.inputs.regenerate_only != 'true'
      run: |
        echo "Scraping Santa Rosa..."
        python library_intercept.py --location santarosa --output santarosa/library_intercept.ics || true
        python scrapers/cityspark/bohemian.py --output santarosa/bohemian.ics || true
        python scrapers/cityspark/pressdemocrat.py --output santarosa/pressdemocrat.ics || true
        python scrapers/sonoma_parks.py --output santarosa/sonoma_parks.ics || true
        python scrapers/cal_theatre.py --output santarosa/cal_theatre.ics || true
        python scrapers/copperfields.py --output santarosa/copperfields.ics || true
        python scrapers/sonoma_county_gov.py --output santarosa/sonoma_county_gov.ics || true
        python scrapers/wix/cafefrida.py --output santarosa/cafefrida.ics || true
        python scrapers/srcc.py --output santarosa/srcc.ics || true
      continue-on-error: true

    - name: Download Santa Rosa live feeds and combine ICS
      if: contains(steps.locations.outputs.list, 'santarosa')
      run: |
        cd santarosa
        curl -sL "https://calendar.google.com/calendar/ical/eventsatarlenefransictheater@gmail.com/public/basic.ics" -o arlene_francis_theater.ics || true
        curl -sL "https://lutherburbankcenter.org/events/?ical=1" -o luther_burbank_center.ics || true
        curl -sL "https://schulzmuseum.org/events/?ical=1" -o schulz_museum.ics || true
        curl -sL "https://www.sonoma.com/events/?ical=1" -o sonoma_com.ics || true
        curl -sL "https://golocal.coop/?post_type=tribe_events&ical=1&eventDisplay=list" -o golocal_coop.ics || true
        curl -sL "https://sonomacountyaa.org/events/?ical=1" -o sonoma_county_aa.ics || true
        curl -sL "https://calendar.google.com/calendar/ical/dsasonomacounty%40gmail.com/public/basic.ics" -o sonoma_county_dsa.ics || true
        # Meetup groups
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/sonoma-county-go-wild-hikers/events/ical/" -o meetup_go_wild_hikers.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/shutupandwritewinecountry/events/ical/" -o meetup_shutupandwrite.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/scottish-country-dancing/events/ical/" -o meetup_scottish_dancing.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/sonoma-county-womens-wine-club/events/ical/" -o meetup_womens_wine_club.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/santa-rosa-toastmasters-public-speaking-meetup-group/events/ical/" -o meetup_toastmasters.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/nataraja-school-of-traditional-yoga/events/ical/" -o meetup_yoga.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/santa-rosa-womens-creativity-collective/events/ical/" -o meetup_creativity.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/sonoma-county-boomers/events/ical/" -o meetup_boomers.ics || true
        cd ..
        # Eventbrite scrape
        python scrapers/eventbrite_scraper.py --location ca--santa-rosa --months ${SCRAPE_MONTHS:-2} > santarosa/eventbrite.ics || true
        python combine_ics.py --input-dir santarosa --output santarosa/combined.ics --name "Santa Rosa Community Calendar"

    # ==========================================
    # Sebastopol
    # ==========================================
    - name: Scrape Sebastopol sources
      if: contains(steps.locations.outputs.list, 'sebastopol') && github.event.inputs.regenerate_only != 'true'
      run: |
        echo "Scraping Sebastopol..."
        python scrapers/sebarts.py --output sebastopol/sebarts.ics || true
        python scrapers/occidental_arts.py --output sebastopol/occidental_arts.ics || true
      continue-on-error: true

    - name: Download Sebastopol live feeds and combine ICS
      if: contains(steps.locations.outputs.list, 'sebastopol')
      run: |
        cd sebastopol
        curl -sL "https://seb.org/?post_type=tribe_events&ical=1&eventDisplay=list" -o sebastopol_community.ics || true
        cd ..
        python combine_ics.py --input-dir sebastopol --output sebastopol/combined.ics --name "Sebastopol Community Calendar"

    # ==========================================
    # Cotati
    # ==========================================
    - name: Scrape Cotati sources
      if: contains(steps.locations.outputs.list, 'cotati') && github.event.inputs.regenerate_only != 'true'
      run: |
        echo "Scraping Cotati..."
        python scrapers/redwood_cafe.py --output cotati/redwood_cafe.ics || true
      continue-on-error: true

    - name: Combine Cotati ICS
      if: contains(steps.locations.outputs.list, 'cotati')
      run: |
        python combine_ics.py --input-dir cotati --output cotati/combined.ics --name "Cotati Community Calendar"

    # ==========================================
    # Sonoma
    # ==========================================
    - name: Scrape Sonoma sources
      if: contains(steps.locations.outputs.list, 'sonoma') && github.event.inputs.regenerate_only != 'true'
      run: |
        echo "Scraping Sonoma..."
        python scrapers/svma.py --output sonoma/svma.ics || true
        python scrapers/sonoma_city.py --output sonoma/sonoma_city.ics || true
      continue-on-error: true

    - name: Combine Sonoma ICS
      if: contains(steps.locations.outputs.list, 'sonoma')
      run: |
        python combine_ics.py --input-dir sonoma --output sonoma/combined.ics --name "Sonoma Community Calendar"

    # ==========================================
    # Bloomington
    # ==========================================
    - name: Scrape Bloomington sources
      if: contains(steps.locations.outputs.list, 'bloomington') && github.event.inputs.regenerate_only != 'true'
      run: |
        echo "Scraping Bloomington..."
        python library_intercept.py --location bloomington --output bloomington/library_intercept.ics || true
      continue-on-error: true

    - name: Download Bloomington live feeds and combine ICS
      if: contains(steps.locations.outputs.list, 'bloomington')
      run: |
        cd bloomington
        curl -sL "https://bgcbloomington.org/events/list/?ical=1" -o bgc_bloomington.ics || true
        curl -sL "https://calendar.google.com/calendar/ical/bloomington.in.gov_1b95au4d2ueudldosb024fimp0@group.calendar.google.com/public/basic.ics" -o bloomington_gov.ics || true
        curl -sL "https://tockify.com/api/feeds/ics/bloomington.arts.calendar" -o bloomington_arts.ics || true
        # IU LiveWhale feeds
        curl -sL "https://events.iu.edu/live/ical/events/group_id/56" -o iu_jacobs_music.ics || true
        curl -sL "https://events.iu.edu/live/ical/events/group_id/378" -o iu_auditorium.ics || true
        curl -sL "https://events.iu.edu/live/ical/events/group_id/234" -o iu_eskenazi_museum.ics || true
        # B-Square Bulletin Google Calendars
        curl -sL "https://calendar.google.com/calendar/ical/bloomington.in.gov_35a6qiaiperdn7b1r6v2ksjlig@group.calendar.google.com/public/basic.ics" -o bsquare_government.ics || true
        curl -sL "https://calendar.google.com/calendar/ical/4dj0guhji982ca5k90ljeliul0@group.calendar.google.com/public/basic.ics" -o bsquare_misc_civic.ics || true
        curl -sL "https://calendar.google.com/calendar/ical/2gd73d7gc46mstrdnr6k7v7b2o@group.calendar.google.com/public/basic.ics" -o bsquare_critical_mass.ics || true
        curl -sL "https://calendar.google.com/calendar/ical/c_02o6fd3erhdmhe4oc5so149ir0@group.calendar.google.com/public/basic.ics" -o bsquare_bptc.ics || true
        cd ..
        python combine_ics.py --input-dir bloomington --output bloomington/combined.ics --name "Bloomington Community Calendar"

    # ==========================================
    # Davis
    # ==========================================
    - name: Scrape Davis sources
      if: contains(steps.locations.outputs.list, 'davis') && github.event.inputs.regenerate_only != 'true'
      run: |
        echo "Scraping Davis..."
        python scrapers/ucdavis_arts.py --output davis/ucdavis_arts.ics || true
        python scrapers/ucdavis_library.py --output davis/ucdavis_library.ics || true
        python scrapers/ucdavis_campusgroups.py --output davis/ucdavis_campusgroups.ics || true
        python scrapers/davis_downtown.py --output davis/davis_downtown.ics || true
        python scrapers/yolo_library.py --output davis/yolo_library.ics || true
        python scrapers/uudavis.py --output davis/uudavis.ics || true
        python davis/scrapers/mondavi_center.py --output davis/mondavi_center.ics || true
        python scrapers/davis_chamber.py --output davis/davis_chamber.ics || true
        python scrapers/ucdavis_athletics.py --output davis/ucdavis_athletics.ics || true
      continue-on-error: true

    - name: Download Davis Meetup feeds and Eventbrite
      if: contains(steps.locations.outputs.list, 'davis')
      run: |
        cd davis
        # Meetup groups
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/mosaics/events/ical/" -o meetup_mosaics.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/intercultural-mosaics/events/ical/" -o meetup_intercultural.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/yolo-county-board-game-gathering/events/ical/" -o meetup_board_games.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/pence-adult-art-programs/events/ical/" -o meetup_pence_art.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/art-in-action/events/ical/" -o meetup_art_in_action.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/mindful-embodied-spirituality/events/ical/" -o meetup_mindful.ics || true
        curl -sL -A "Mozilla/5.0" "https://www.meetup.com/winters-shut-up-and-write-meetup-group/events/ical/" -o meetup_winters_write.ics || true
        cd ..
        # Eventbrite scrape
        python scrapers/eventbrite_scraper.py --location ca--davis --months ${SCRAPE_MONTHS:-2} --cities davis woodland dixon winters "west sacramento" > davis/eventbrite.ics || true

    - name: Combine Davis ICS
      if: contains(steps.locations.outputs.list, 'davis')
      run: |
        python combine_ics.py --input-dir davis --output davis/combined.ics --name "Davis Community Calendar"

    # ==========================================
    # Post-processing (all cities)
    # ==========================================
    - name: Convert ICS to JSON for Supabase
      run: |
        IFS=',' read -ra CITIES <<< "${{ steps.locations.outputs.list }}"
        for city in "${CITIES[@]}"; do
          if [ -f "$city/combined.ics" ]; then
            python ics_to_json.py "$city/combined.ics" -o "$city/events.json" --city "$city"
            echo "$city: Converted $(cat $city/events.json | python -c 'import json,sys; print(len(json.load(sys.stdin)))') events to JSON"
          fi
        done

    - name: Generate feed health report
      run: |
        python report.py --cities ${{ steps.locations.outputs.list }}

    - name: Commit and push if changes
      env:
        GITHUB_TOKEN: ${{ secrets.COMMUNITY_CALENDAR }}
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
        git add .
        git diff --quiet && git diff --staged --quiet || (
          git commit -m "Auto-generate calendar"
          for i in 1 2 3; do
            git pull --rebase && git push && break
            echo "Push failed, retrying in 5 seconds..."
            sleep 5
          done
        )

    - name: Wait for GitHub Pages to update
      run: |
        echo "Waiting for GitHub Pages to update..."
        sleep 120  # Wait 2 minutes for GitHub Pages cache to update
        
        # Verify at least one JSON file is accessible
        for i in 1 2 3; do
          if curl -sL "https://judell.github.io/community-calendar/santarosa/events.json" | head -c 100 | grep -q '"title"'; then
            echo "GitHub Pages is serving updated content"
            break
          fi
          echo "Waiting for GitHub Pages (attempt $i)..."
          sleep 30
        done

    - name: Trigger Supabase events reload
      env:
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      run: |
        echo "Triggering Supabase Edge Function to reload events..."
        RESPONSE=$(curl -sL -X POST 'https://dzpdualvwspgqghrysyz.supabase.co/functions/v1/load-events' \
          -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
          -H 'Content-Type: application/json')
        echo "$RESPONSE" | jq .

        # Check for success
        SUCCESS=$(echo "$RESPONSE" | jq -r '.success // false')
        if [ "$SUCCESS" = "true" ]; then
          INSERTED=$(echo "$RESPONSE" | jq -r '.inserted')
          echo "Successfully loaded $INSERTED events into Supabase"
        else
          echo "Failed to load events"
          echo "$RESPONSE"
          exit 1
        fi
