name: Generate Calendar

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      locations:
        description: 'Locations to process (comma-separated: santarosa,sebastopol,bloomington or "all")'
        required: false
        default: 'all'
      regenerate_only:
        description: 'Skip scraping, only regenerate HTML from existing local ICS files'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '0 0 * * *'

jobs:
  generate-calendar:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check out repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libxml2-dev libxslt-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Node dependencies (for Puppeteer)
      run: |
        npm install puppeteer
        npx puppeteer browsers install chrome

    - name: Calculate dates
      id: dates
      run: |
        THIS_YEAR=$(date +%Y)
        THIS_MONTH=$(date +%m)
        
        NEXT=$(date -d "$(date +%Y-%m-01) +1 month" +%Y-%m)
        NEXT_YEAR=${NEXT%-*}
        NEXT_MONTH=${NEXT#*-}
        
        NEXT2=$(date -d "$(date +%Y-%m-01) +2 months" +%Y-%m)
        NEXT2_YEAR=${NEXT2%-*}
        NEXT2_MONTH=${NEXT2#*-}
        
        echo "this_year=$THIS_YEAR" >> $GITHUB_OUTPUT
        echo "this_month=$THIS_MONTH" >> $GITHUB_OUTPUT
        echo "next_year=$NEXT_YEAR" >> $GITHUB_OUTPUT
        echo "next_month=$NEXT_MONTH" >> $GITHUB_OUTPUT
        echo "next2_year=$NEXT2_YEAR" >> $GITHUB_OUTPUT
        echo "next2_month=$NEXT2_MONTH" >> $GITHUB_OUTPUT
        
        echo "Dates: $THIS_YEAR-$THIS_MONTH, $NEXT_YEAR-$NEXT_MONTH, $NEXT2_YEAR-$NEXT2_MONTH"

    - name: Determine locations to process
      id: locations
      run: |
        INPUT="${{ github.event.inputs.locations }}"
        if [ -z "$INPUT" ] || [ "$INPUT" = "all" ]; then
          echo "list=santarosa,sebastopol,bloomington" >> $GITHUB_OUTPUT
        else
          echo "list=$INPUT" >> $GITHUB_OUTPUT
        fi

    # ==========================================
    # Santa Rosa
    # ==========================================
    - name: Scrape Santa Rosa sources
      if: contains(steps.locations.outputs.list, 'santarosa') && github.event.inputs.regenerate_only != 'true'
      run: |
        echo "Processing Santa Rosa..."
        for period in "this" "next" "next2"; do
          if [ "$period" = "this" ]; then
            Y=${{ steps.dates.outputs.this_year }}
            M=${{ steps.dates.outputs.this_month }}
          elif [ "$period" = "next" ]; then
            Y=${{ steps.dates.outputs.next_year }}
            M=${{ steps.dates.outputs.next_month }}
          else
            Y=${{ steps.dates.outputs.next2_year }}
            M=${{ steps.dates.outputs.next2_month }}
          fi
          
          echo "Scraping Santa Rosa for $Y-$M..."
          python library_intercept.py --location santarosa --year $Y --month $M || true
          python eventbrite.py santarosa $Y $M || true
          cd santarosa && python bohemian.py $Y $((10#$M)) || true
          python pressdemocrat.py $Y $((10#$M)) || true
          cd ..
        done
      continue-on-error: true

    - name: Update Santa Rosa feeds.txt
      if: contains(steps.locations.outputs.list, 'santarosa') && github.event.inputs.regenerate_only != 'true'
      run: |
        # Create feeds.txt with LOCAL paths for generation
        cat > santarosa/feeds.txt << EOF
        # Live feeds (fetched directly)
        https://calendar.google.com/calendar/ical/eventsatarlenefransictheater@gmail.com/public/basic.ics
        https://lutherburbankcenter.org/events/?ical=1
        https://schulzmuseum.org/events/?ical=1

        # Local scraped files
        santarosa/library_intercept_${{ steps.dates.outputs.this_year }}_${{ steps.dates.outputs.this_month }}.ics
        santarosa/eventbrite_${{ steps.dates.outputs.this_year }}_${{ steps.dates.outputs.this_month }}.ics
        santarosa/bohemian_${{ steps.dates.outputs.this_year }}_${{ steps.dates.outputs.this_month }}.ics
        santarosa/pressdemocrat_${{ steps.dates.outputs.this_year }}_${{ steps.dates.outputs.this_month }}.ics

        santarosa/library_intercept_${{ steps.dates.outputs.next_year }}_${{ steps.dates.outputs.next_month }}.ics
        santarosa/eventbrite_${{ steps.dates.outputs.next_year }}_${{ steps.dates.outputs.next_month }}.ics
        santarosa/bohemian_${{ steps.dates.outputs.next_year }}_${{ steps.dates.outputs.next_month }}.ics
        santarosa/pressdemocrat_${{ steps.dates.outputs.next_year }}_${{ steps.dates.outputs.next_month }}.ics

        santarosa/library_intercept_${{ steps.dates.outputs.next2_year }}_${{ steps.dates.outputs.next2_month }}.ics
        santarosa/eventbrite_${{ steps.dates.outputs.next2_year }}_${{ steps.dates.outputs.next2_month }}.ics
        santarosa/bohemian_${{ steps.dates.outputs.next2_year }}_${{ steps.dates.outputs.next2_month }}.ics
        santarosa/pressdemocrat_${{ steps.dates.outputs.next2_year }}_${{ steps.dates.outputs.next2_month }}.ics

        # City calendars
        santarosa/SRCity_Main_Calendar.ics
        santarosa/SRCity_City_Offices_Closed.ics
        santarosa/SRCity_Recreation_and_Parks.ics
        santarosa/SRCity_Events.ics
        EOF
        sed -i 's/^[[:space:]]*//' santarosa/feeds.txt

    - name: Generate Santa Rosa calendars
      if: contains(steps.locations.outputs.list, 'santarosa')
      run: |
        LOCAL_ONLY_FLAG=""
        if [ "${{ github.event.inputs.regenerate_only }}" = "true" ]; then
          LOCAL_ONLY_FLAG="--local-only"
        fi
        python cal.py --generate --location santarosa --year ${{ steps.dates.outputs.this_year }} --month ${{ steps.dates.outputs.this_month }} --timezone "America/Los_Angeles" $LOCAL_ONLY_FLAG
        python cal.py --generate --location santarosa --year ${{ steps.dates.outputs.next_year }} --month ${{ steps.dates.outputs.next_month }} --timezone "America/Los_Angeles" $LOCAL_ONLY_FLAG
        python cal.py --generate --location santarosa --year ${{ steps.dates.outputs.next2_year }} --month ${{ steps.dates.outputs.next2_month }} --timezone "America/Los_Angeles" $LOCAL_ONLY_FLAG

    # ==========================================
    # Sebastopol
    # ==========================================
    - name: Scrape Sebastopol sources
      if: contains(steps.locations.outputs.list, 'sebastopol') && github.event.inputs.regenerate_only != 'true'
      run: |
        echo "Processing Sebastopol..."
        for period in "this" "next" "next2"; do
          if [ "$period" = "this" ]; then
            Y=${{ steps.dates.outputs.this_year }}
            M=${{ steps.dates.outputs.this_month }}
          elif [ "$period" = "next" ]; then
            Y=${{ steps.dates.outputs.next_year }}
            M=${{ steps.dates.outputs.next_month }}
          else
            Y=${{ steps.dates.outputs.next2_year }}
            M=${{ steps.dates.outputs.next2_month }}
          fi
          
          echo "Scraping Sebastopol for $Y-$M..."
          cd sebastopol
          python sebarts.py --year $Y --month $((10#$M)) || true
          python occidental_arts.py --year $Y --month $((10#$M)) || true
          cd ..
        done
      continue-on-error: true

    - name: Update Sebastopol feeds.txt
      if: contains(steps.locations.outputs.list, 'sebastopol') && github.event.inputs.regenerate_only != 'true'
      run: |
        cat > sebastopol/feeds.txt << EOF
        # Live feed
        https://seb.org/?post_type=tribe_events&ical=1&eventDisplay=list

        # Local scraped files
        sebastopol/sebarts_${{ steps.dates.outputs.this_year }}_${{ steps.dates.outputs.this_month }}.ics
        sebastopol/occidental_arts_${{ steps.dates.outputs.this_year }}_${{ steps.dates.outputs.this_month }}.ics
        sebastopol/sebarts_${{ steps.dates.outputs.next_year }}_${{ steps.dates.outputs.next_month }}.ics
        sebastopol/occidental_arts_${{ steps.dates.outputs.next_year }}_${{ steps.dates.outputs.next_month }}.ics
        sebastopol/sebarts_${{ steps.dates.outputs.next2_year }}_${{ steps.dates.outputs.next2_month }}.ics
        sebastopol/occidental_arts_${{ steps.dates.outputs.next2_year }}_${{ steps.dates.outputs.next2_month }}.ics
        EOF
        sed -i 's/^[[:space:]]*//' sebastopol/feeds.txt

    - name: Generate Sebastopol calendars
      if: contains(steps.locations.outputs.list, 'sebastopol')
      run: |
        LOCAL_ONLY_FLAG=""
        if [ "${{ github.event.inputs.regenerate_only }}" = "true" ]; then
          LOCAL_ONLY_FLAG="--local-only"
        fi
        python cal.py --generate --location sebastopol --year ${{ steps.dates.outputs.this_year }} --month ${{ steps.dates.outputs.this_month }} --timezone "America/Los_Angeles" $LOCAL_ONLY_FLAG
        python cal.py --generate --location sebastopol --year ${{ steps.dates.outputs.next_year }} --month ${{ steps.dates.outputs.next_month }} --timezone "America/Los_Angeles" $LOCAL_ONLY_FLAG
        python cal.py --generate --location sebastopol --year ${{ steps.dates.outputs.next2_year }} --month ${{ steps.dates.outputs.next2_month }} --timezone "America/Los_Angeles" $LOCAL_ONLY_FLAG

    # ==========================================
    # Bloomington
    # ==========================================
    - name: Scrape Bloomington sources
      if: contains(steps.locations.outputs.list, 'bloomington') && github.event.inputs.regenerate_only != 'true'
      run: |
        echo "Processing Bloomington..."
        for period in "this" "next" "next2"; do
          if [ "$period" = "this" ]; then
            Y=${{ steps.dates.outputs.this_year }}
            M=${{ steps.dates.outputs.this_month }}
          elif [ "$period" = "next" ]; then
            Y=${{ steps.dates.outputs.next_year }}
            M=${{ steps.dates.outputs.next_month }}
          else
            Y=${{ steps.dates.outputs.next2_year }}
            M=${{ steps.dates.outputs.next2_month }}
          fi
          
          echo "Scraping Bloomington for $Y-$M..."
          python library_intercept.py --location bloomington --year $Y --month $M || true
          python eventbrite.py bloomington $Y $M || true
        done
      continue-on-error: true

    - name: Update Bloomington feeds.txt
      if: contains(steps.locations.outputs.list, 'bloomington') && github.event.inputs.regenerate_only != 'true'
      run: |
        cat > bloomington/feeds.txt << EOF
        # Local scraped files
        bloomington/library_intercept_${{ steps.dates.outputs.this_year }}_${{ steps.dates.outputs.this_month }}.ics
        bloomington/eventbrite_${{ steps.dates.outputs.this_year }}_${{ steps.dates.outputs.this_month }}.ics
        bloomington/library_intercept_${{ steps.dates.outputs.next_year }}_${{ steps.dates.outputs.next_month }}.ics
        bloomington/eventbrite_${{ steps.dates.outputs.next_year }}_${{ steps.dates.outputs.next_month }}.ics
        bloomington/library_intercept_${{ steps.dates.outputs.next2_year }}_${{ steps.dates.outputs.next2_month }}.ics
        bloomington/eventbrite_${{ steps.dates.outputs.next2_year }}_${{ steps.dates.outputs.next2_month }}.ics

        # Static/live feeds
        bloomington/bluebird.ics
        https://bgcbloomington.org/events/list/?ical=1
        https://calendar.google.com/calendar/ical/bloomington.in.gov_1b95au4d2ueudldosb024fimp0@group.calendar.google.com/public/basic.ics
        https://tockify.com/api/feeds/ics/bloomington.arts.calendar
        EOF
        sed -i 's/^[[:space:]]*//' bloomington/feeds.txt

    - name: Generate Bloomington calendars
      if: contains(steps.locations.outputs.list, 'bloomington')
      run: |
        LOCAL_ONLY_FLAG=""
        if [ "${{ github.event.inputs.regenerate_only }}" = "true" ]; then
          LOCAL_ONLY_FLAG="--local-only"
        fi
        python cal.py --generate --location bloomington --year ${{ steps.dates.outputs.this_year }} --month ${{ steps.dates.outputs.this_month }} --timezone "America/Indiana/Indianapolis" $LOCAL_ONLY_FLAG
        python cal.py --generate --location bloomington --year ${{ steps.dates.outputs.next_year }} --month ${{ steps.dates.outputs.next_month }} --timezone "America/Indiana/Indianapolis" $LOCAL_ONLY_FLAG
        python cal.py --generate --location bloomington --year ${{ steps.dates.outputs.next2_year }} --month ${{ steps.dates.outputs.next2_month }} --timezone "America/Indiana/Indianapolis" $LOCAL_ONLY_FLAG
      
    - name: Commit and push if changes
      env:
        GITHUB_TOKEN: ${{ secrets.COMMUNITY_CALENDAR }}
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
        git add .
        git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-generate calendar for current and next 2 months" && git push)
