<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>List View Development</title>
  <link rel="stylesheet" href="list-styles.css">
</head>
<body>
  <div id="app"></div>
  <script>
    // Source URL mappings
    const sourceUrls = {
      'Bohemian': 'https://www.bohemian.com/events/',
      'Press Democrat': 'https://pressdemocrat.com/events/',
      'Santa Rosa Library': 'https://sonomalibrary.org/events',
      'Eventbrite': 'https://www.eventbrite.com/d/ca--santa-rosa/all-events/',
      'AFC Events & Activities': 'https://arlenefransictheater.org/',
      'Luther Burbank Center for the Arts': 'https://lutherburbankcenter.org/events/',
      'Charles M. Schulz Museum': 'https://schulzmuseum.org/events/',
      // Add more as needed
    };
    
    function linkifySource(text) {
      // Find "Source: xxx" and make it a link (handle multiline)
      const match = text.match(/Source:\s*([^<\n]+)/m);
      if (match) {
        const sourceName = match[1].trim();
        const url = sourceUrls[sourceName];
        if (url) {
          return text.replace(
            /Source:\s*([^<\n]+)/m,
            `<a href="${url}" target="_blank" rel="noopener" class="source-badge">ðŸ“° ${sourceName}</a>`
          );
        } else {
          return text.replace(
            /Source:\s*([^<\n]+)/m,
            `<span class="source-badge">ðŸ“° ${sourceName}</span>`
          );
        }
      }
      return text;
    }
    
    // Load the generated HTML and extract/transform content
    async function loadContent() {
      const params = new URLSearchParams(window.location.search);
      const location = params.get('location') || 'santarosa';
      const year = params.get('year') || '2026';
      const month = params.get('month') || '02';
      
      const url = `${location}/${year}-${month}-l.html`;
      
      try {
        const response = await fetch(url);
        const html = await response.text();
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        const h1 = doc.querySelector('h1');
        const calendarWidget = doc.getElementById('calendar-widget');
        const eventList = doc.querySelector('.event-list');
        
        // Transform event details to add source links
        if (eventList) {
          eventList.querySelectorAll('.event-details').forEach(details => {
            details.innerHTML = linkifySource(details.innerHTML);
          });
        }
        
        document.getElementById('app').innerHTML = `
          <header>
            ${h1 ? h1.outerHTML : ''}
          </header>
          <nav id="calendar-widget">
            ${calendarWidget ? calendarWidget.innerHTML : ''}
          </nav>
          <main class="event-list">
            ${eventList ? eventList.innerHTML : ''}
          </main>
        `;
        
        // Reattach scroll handlers
        document.querySelectorAll('#calendar-widget td[onclick]').forEach(td => {
          const match = td.getAttribute('onclick')?.match(/scrollToDay\('([^']+)'\)/);
          if (match) {
            td.onclick = () => scrollToDay(match[1]);
          }
        });
        
      } catch (e) {
        document.getElementById('app').innerHTML = `<p style="padding:2rem;text-align:center">Error loading: ${e.message}</p>`;
      }
    }
    
    function scrollToDay(dateId) {
      const element = document.getElementById(dateId);
      if (element) {
        element.scrollIntoView({ behavior: 'smooth' });
      }
    }
    
    loadContent();
  </script>
</body>
</html>
