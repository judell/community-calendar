<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Community Calendar</title>
    <style>
      .subscribe-banner {
        background: #f0f7ff;
        border: 1px solid #cce0ff;
        border-radius: 8px;
        padding: 12px 16px;
        margin: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
      .subscribe-banner a {
        color: #1e40af;
        text-decoration: none;
        font-weight: 500;
      }
      .subscribe-banner a:hover {
        text-decoration: underline;
      }
      .subscribe-icon {
        font-size: 20px;
      }
    </style>
    <script src="https://xmlui.org/xmlui.js"></script>
    <script>
      // Date range helpers for upcoming events (one hour ago to one week out)
      // Pre-compute at load time to avoid timing issues with XMLUI expressions
      (function() {
        const now = new Date();
        const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
        const oneWeekLater = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
        window.fromDate = oneHourAgo.toISOString();
        window.toDate = oneWeekLater.toISOString();
        console.log('Date range initialized:', window.fromDate, 'to', window.toDate);
      })();

      // Keep functions for debugging
      window.getFromDate = function() { return window.fromDate; };
      window.getToDate = function() { return window.toDate; };

      // Filter events by search term
      window.filterEvents = function(events, term) {
        if (!events || !term) return events || [];
        const lower = term.toLowerCase();
        return events.filter(e =>
          (e.title && e.title.toLowerCase().includes(lower)) ||
          (e.location && e.location.toLowerCase().includes(lower)) ||
          (e.description && e.description.toLowerCase().includes(lower))
        );
      };

      // Format day of week (using UTC since times were stored as local but marked UTC)
      window.formatDayOfWeek = function(isoString) {
        if (!isoString) return '';
        return new Date(isoString).toLocaleDateString('en-US', { weekday: 'short', timeZone: 'UTC' });
      };

      // Format month and day (using UTC since times were stored as local but marked UTC)
      window.formatMonthDay = function(isoString) {
        if (!isoString) return '';
        return new Date(isoString).toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' });
      };

      // Format date for display
      window.formatDate = function(isoString) {
        if (!isoString) return '';
        const d = new Date(isoString);
        return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
      };

      // Format time for display
      // Times were stored as local times but Supabase added +00:00, so use UTC values directly
      window.formatTime = function(isoString) {
        if (!isoString) return '';
        const d = new Date(isoString);
        const hours = d.getUTCHours();
        const mins = d.getUTCMinutes();
        // Skip midnight times (likely means time unknown)
        if (hours === 0 && mins === 0) return '';
        // Format as 12-hour time
        const h = hours % 12 || 12;
        const ampm = hours < 12 ? 'AM' : 'PM';
        const m = mins.toString().padStart(2, '0');
        return `${h}:${m} ${ampm}`;
      };

      // Truncate text with ellipsis
      window.truncate = function(text, maxLen) {
        if (!text) return '';
        if (text.length <= maxLen) return text;
        return text.substring(0, maxLen).trim() + '...';
      };

      // Aggregate events by source, return sorted array of {source, count}
      window.getSourceCounts = function(events) {
        if (!events || !events.length) return [];
        const counts = {};
        events.forEach(e => {
          const src = e.source || 'Unknown';
          counts[src] = (counts[src] || 0) + 1;
        });
        return Object.entries(counts)
          .map(([source, count]) => ({ source, count }))
          .sort((a, b) => b.count - a.count);
      };
    </script>
  </head>
  <body>
    <div class="subscribe-banner">
      <span class="subscribe-icon">ðŸ“…</span>
      <span>
        Subscribe to this calendar: 
        <a href="santarosa/combined.ics">Download ICS</a> | 
        <a href="webcal://judell.github.io/community-calendar/santarosa/combined.ics">Add to Calendar App</a>
      </span>
    </div>
  </body>
</html>
