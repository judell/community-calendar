<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Feed Health Report</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.5;
            color: #333;
        }

        h1 { margin-bottom: 5px; }

        .generated {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .anomalies { margin-top: 30px; margin-bottom: 20px; }

        .anomaly {
            padding: 8px 12px;
            margin: 6px 0;
            border-left: 3px solid;
            background: #fafafa;
        }

        .anomaly.high { border-color: #d32f2f; }
        .anomaly.medium { border-color: #f57c00; }
        .anomaly .meta { font-size: 0.85em; color: #666; }
        .anomaly code { font-size: 0.85em; word-break: break-all; }

        details { margin-bottom: 4px; }
        details > summary { cursor: pointer; padding: 4px 0; }
        details > summary > span { display: inline; }

        .city-name { font-weight: 600; text-transform: capitalize; }
        .city-stats { color: #666; }

        .feed-name { font-weight: 500; }
        .feed-count { color: #666; }
        .feed-count.zero { color: #d32f2f; }
        .feed-count.error { color: #d32f2f; font-size: 0.85em; }

        .sparkline {
            height: 30px;
            display: flex;
            align-items: flex-end;
            gap: 1px;
            margin: 8px 0 4px;
        }

        .sparkline .bar {
            flex: 1;
            min-width: 3px;
            max-width: 10px;
            background: #666;
            border-radius: 1px 1px 0 0;
        }

        .sparkline .bar.error { background: #d32f2f; }
        .sparkline .bar.zero { background: #f57c00; min-height: 2px; }

        .sparkline-mini {
            display: inline-flex;
            align-items: flex-end;
            gap: 1px;
            height: 12px;
            vertical-align: middle;
            margin-left: 6px;
        }
        .sparkline-mini .bar {
            width: 3px;
            background: #999;
            border-radius: 1px 1px 0 0;
        }
        .sparkline-mini .bar.error { background: #d32f2f; }
        .sparkline-mini .bar.zero { background: #f57c00; min-height: 1px; }
        .history-label { font-size: 0.75em; color: #999; }
        .feed-detail { padding-left: 20px; }
        .city-content { padding-left: 10px; }

        .feed-section { margin-top: 20px; }
        .feed-section h2 { margin-bottom: 4px; }
        .section-desc { font-size: 0.85em; color: #666; margin-bottom: 12px; }
        .url-section { margin-top: 30px; }
        .url-section h2 { margin-bottom: 4px; }
        .url-table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin: 8px 0; }
        .url-table th { text-align: left; padding: 4px 8px; border-bottom: 2px solid #ddd; }
        .url-table td { padding: 4px 8px; border-bottom: 1px solid #eee; }
        .url-table td.num { text-align: right; }

        .url-table a { color: #1976d2; text-decoration: none; word-break: break-all; }
        .url-table a:hover { text-decoration: underline; }
        .url-summary { display: flex; gap: 20px; flex-wrap: wrap; margin: 8px 0; }
        .url-stat { background: #f5f5f5; padding: 8px 14px; border-radius: 6px; }
        .url-stat .label { font-size: 0.8em; color: #666; }
        .url-stat .value { font-size: 1.3em; font-weight: 600; }
        .help-btn {
            display: inline-block; width: 16px; height: 16px; line-height: 16px;
            text-align: center; border-radius: 50%; background: #e0e0e0; color: #666;
            font-size: 11px; font-weight: 600; cursor: pointer; vertical-align: middle;
            margin-left: 4px; user-select: none;
        }
        .help-btn:hover { background: #bbb; color: #333; }
        .help-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); z-index: 1000; justify-content: center; align-items: center;
        }
        .help-overlay.open { display: flex; }
        .help-dialog {
            background: white; border-radius: 8px; padding: 24px; max-width: 500px;
            margin: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); position: relative;
        }
        .help-dialog h3 { margin-top: 0; }
        .help-close {
            position: absolute; top: 8px; right: 12px; cursor: pointer;
            font-size: 20px; color: #999; background: none; border: none;
        }
        .help-close:hover { color: #333; }
        .pct-bar { display: inline-block; height: 8px; border-radius: 4px; vertical-align: middle; }
        .pct-bar.good { background: #4caf50; }
        .pct-bar.mid { background: #f57c00; }
        .pct-bar.bad { background: #d32f2f; }
    </style>
</head>
<body>
    <h1>Calendar Feed Health Report</h1>
    <div class="generated" id="generated">Loading...</div>

    <div class="feed-section">
        <h2>Ingestion by Day</h2>
        <div class="section-desc">Future events per feed, summed across feeds (duplicates possible when sources overlap)</div>
        <div id="cities"></div>
    </div>

    <details class="anomalies" id="build-errors" style="display:none">
        <summary><strong>Build Errors</strong> (<span id="error-count">0</span>)</summary>
        <div id="error-list"></div>
    </details>

    <div class="url-section">
        <h2>URL Quality</h2>
        <div class="section-desc">Deduplicated events from the combined calendar</div>
        <div id="url-report">Loading...</div>
    </div>

    <details class="anomalies" id="anomalies">
        <summary><strong>Anomalies</strong> (<span id="anomaly-count">0</span>)</summary>
        <div id="anomaly-list">Loading...</div>
    </details>

    <div class="help-overlay" id="helpOverlay" onclick="if(event.target===this)closeHelp()">
        <div class="help-dialog">
            <button class="help-close" onclick="closeHelp()">&times;</button>
            <h3 id="helpTitle"></h3>
            <div id="helpBody"></div>
        </div>
    </div>

    <script>
        async function loadReport() {
            try {
                const response = await fetch('report.json');
                if (!response.ok) throw new Error('Failed to load report');
                renderReport(await response.json());
            } catch (e) {
                document.getElementById('generated').textContent = 'Error: ' + e.message;
            }
        }

        function capitalize(s) {
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        function renderReport(data) {
            document.getElementById('generated').textContent =
                'Last updated: ' + new Date(data.generated).toLocaleString();

            const cityTotals = {};
            for (const [city, cityData] of Object.entries(data.cities || {})) {
                cityTotals[city] = Object.values(cityData.feeds || {}).reduce((sum, feed) => {
                    const latest = (feed.history || []).slice(-1)[0];
                    return sum + (latest && !latest.error ? latest.count : 0);
                }, 0);
            }

            const recentAnomalies = (data.anomalies || [])
                .sort((a, b) => b.date.localeCompare(a.date))
                .slice(0, 20);

            document.getElementById('anomaly-count').textContent = recentAnomalies.length;
            const anomalyList = document.getElementById('anomaly-list');
            if (recentAnomalies.length === 0) {
                anomalyList.innerHTML = '<div>No anomalies detected</div>';
            } else {
                anomalyList.innerHTML = recentAnomalies.map(a => `
                    <div class="anomaly ${a.severity}">
                        <strong>${a.feed}</strong>: ${a.message}
                        <div class="meta">${a.city} &bull; ${a.date}</div>
                    </div>
                `).join('');
            }

            const citiesContainer = document.getElementById('cities');
            citiesContainer.innerHTML = '';

            for (const [cityName, cityData] of Object.entries(data.cities || {})) {
                const feeds = Object.entries(cityData.feeds || {})
                    .sort((a, b) => {
                        const aCount = ((a[1].history || []).slice(-1)[0] || {}).count || 0;
                        const bCount = ((b[1].history || []).slice(-1)[0] || {}).count || 0;
                        return bCount - aCount;
                    });

                const total = cityTotals[cityName] || 0;

                const cityEl = document.createElement('details');
                cityEl.innerHTML = `
                    <summary><span class="city-name">${capitalize(cityName)}</span> <span class="city-stats">${total.toLocaleString()} events from ${feeds.length} feeds</span></summary>
                    <div class="city-content">
                        ${feeds.map(([name, feed]) => renderFeed(name, feed)).join('')}
                    </div>
                `;
                citiesContainer.appendChild(cityEl);
            }

            renderBuildErrors(data);
            renderUrlReport(data);
        }

        function renderBuildErrors(data) {
            const errors = data.errors || [];
            const container = document.getElementById('build-errors');
            const list = document.getElementById('error-list');
            document.getElementById('error-count').textContent = errors.length;
            if (errors.length === 0) return;
            container.style.display = '';
            list.innerHTML = errors.map(e => `
                <div class="anomaly high">
                    <strong>${e.source || 'unknown'}</strong>: <code>${e.line}</code>
                    <div class="meta">${e.date}</div>
                </div>
            `).join('');
        }

        function renderFeed(name, feed) {
            const history = (feed.history || []).slice(-30);
            const latest = history[history.length - 1] || {};
            const maxCount = Math.max(...history.map(h => h.count || 0), 1);

            let countClass = '';
            let countText = `${latest.count || 0} events`;

            if (latest.error) {
                countClass = 'error';
                countText = `error: ${latest.error}`;
            } else if (latest.count === 0) {
                countClass = 'zero';
                countText = '0 events';
            }

            const miniSparkline = history.slice(-14).map(h => {
                const height = h.count ? Math.max(10, (h.count / maxCount) * 100) : 0;
                let barClass = '';
                if (h.error) barClass = 'error';
                else if (h.count === 0) barClass = 'zero';
                return `<div class="bar ${barClass}" style="height:${height}%" title="${h.date}: ${h.error || h.count + ' events'}"></div>`;
            }).join('');

            const sparkline = history.map(h => {
                const height = h.count ? Math.max(10, (h.count / maxCount) * 100) : 0;
                let barClass = '';
                if (h.error) barClass = 'error';
                else if (h.count === 0) barClass = 'zero';
                return `<div class="bar ${barClass}" style="height:${height}%" title="${h.date}: ${h.error || h.count + ' events'}"></div>`;
            }).join('');

            const range = history.length > 1
                ? `${history[0].date} to ${history[history.length-1].date}`
                : (history[0]?.date || 'No data');

            return `
                <details>
                    <summary><span class="feed-name">${name}</span> <span class="feed-count ${countClass}">${countText}</span> <span class="sparkline-mini">${miniSparkline}</span></summary>
                    <div class="feed-detail">
                        <div class="sparkline">${sparkline}</div>
                        <div class="history-label">${range} (${history.length} days)</div>
                    </div>
                </details>
            `;
        }

        function renderUrlReport(data) {
            const container = document.getElementById('url-report');
            let html = '';
            for (const [cityName, cityData] of Object.entries(data.cities || {})) {
                const uq = cityData.url_quality;
                if (!uq) continue;

                const specificPct = uq.total_with_url > 0
                    ? Math.round((uq.total_with_url - uq.generic_count) / uq.total_with_url * 100) : 100;

                html += `
                    <details>
                        <summary><span class="city-name">${capitalize(cityName)}</span>
                            <span class="city-stats">${specificPct}% event-specific</span>
                        </summary>
                        <div class="city-content">
                            <div class="url-summary">
                                <div class="url-stat"><div class="label">Events with URL</div><div class="value">${uq.total_with_url.toLocaleString()} / ${uq.total_events.toLocaleString()}</div></div>
                                <div class="url-stat"><div class="label">Unique URLs</div><div class="value">${uq.unique_urls.toLocaleString()}</div></div>
                                <div class="url-stat"><div class="label">Generic URL events <span class="help-btn" onclick="showHelp('generic')">?</span></div><div class="value" style="color:${uq.generic_count > 0 ? '#d32f2f' : '#4caf50'}">${uq.generic_count} (${100 - specificPct}%)</div></div>
                                <div class="url-stat"><div class="label">HTTP (not HTTPS)</div><div class="value" style="color:${uq.http_count > 0 ? '#f57c00' : '#4caf50'}">${uq.http_count} (${uq.http_domains} domains)</div></div>
                            </div>
                            ${uq.generic_domains.length ? `
                            <details>
                                <summary>Generic URLs (${uq.generic_domains.length} domains, ${uq.generic_count} events)</summary>
                                <table class="url-table">
                                    <tr><th>Domain</th><th>Events</th><th>URL</th></tr>
                                    ${uq.generic_domains.map(g => `
                                        <tr class="warn"><td>${g.domain}</td><td class="num">${g.events}</td><td><a href="${g.url}" target="_blank">${g.url.length > 60 ? g.url.substring(0, 60) + '...' : g.url}</a></td></tr>
                                    `).join('')}
                                </table>
                            </details>` : ''}
                            <details>
                                <summary>URL specificity by source</summary>
                                <table class="url-table">
                                    <tr><th>Source</th><th>Events</th><th>Unique URLs</th><th>Specificity <span class="help-btn" onclick="showHelp('specificity')">?</span></th></tr>
                                    ${(uq.source_specificity || []).map(r => `
                                        <tr class="${r.specificity_pct < 20 ? 'warn' : r.specificity_pct < 50 ? 'caution' : ''}">
                                            <td>${r.source}</td><td class="num">${r.events}</td><td class="num">${r.unique_urls}</td>
                                            <td><span class="pct-bar ${r.specificity_pct >= 80 ? 'good' : r.specificity_pct >= 40 ? 'mid' : 'bad'}" style="width:${Math.max(4, r.specificity_pct * 0.6)}px"></span> ${r.specificity_pct}%</td>
                                        </tr>
                                    `).join('')}
                                </table>
                            </details>
                        </div>
                    </details>
                `;
            }
            if (!html) {
                container.innerHTML = '<div>No URL quality data available (next build will generate it)</div>';
                return;
            }
            container.innerHTML = html;
        }

        const helpDefs = {
            generic: {
                title: 'Generic URL Events',
                body: 'Events whose URL points to a generic page (homepage, calendar listing) rather than a page about that specific event. Every event from the domain shares the same URL. Clicking takes the user to a page with no direct connection to the event they were looking at.<br><br>Common causes: the source calendar doesn\'t provide per-event links, or the scraper can only extract the venue\'s top-level URL.'
            },
            specificity: {
                title: 'URL Specificity',
                body: 'The percentage of a source\'s events that have a unique URL. 100% means every event links to its own page. Low specificity means many events share the same URL.<br><br><b>Green (80%+)</b>: most events have their own page.<br><b>Orange (40\u201379%)</b>: mixed \u2014 some events link to specific pages, others to generic ones.<br><b>Red (&lt;40%)</b>: most events link to the same generic page.'
            }
        };

        function showHelp(key) {
            const def = helpDefs[key];
            if (!def) return;
            document.getElementById('helpTitle').textContent = def.title;
            document.getElementById('helpBody').innerHTML = def.body;
            document.getElementById('helpOverlay').classList.add('open');
        }

        function closeHelp() {
            document.getElementById('helpOverlay').classList.remove('open');
        }

        loadReport();
    </script>
</body>
</html>
