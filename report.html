<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Feed Health Report</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.5;
            color: #333;
        }

        h1 { margin-bottom: 5px; }

        .generated {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .anomalies { margin-bottom: 20px; }

        .anomaly {
            padding: 8px 12px;
            margin: 6px 0;
            border-left: 3px solid;
            background: #fafafa;
        }

        .anomaly.high { border-color: #d32f2f; }
        .anomaly.medium { border-color: #f57c00; }
        .anomaly .meta { font-size: 0.85em; color: #666; }

        details { margin-bottom: 4px; }
        details > summary { cursor: pointer; padding: 4px 0; }
        details > summary > span { display: inline; }

        .city-name { font-weight: 600; text-transform: capitalize; }
        .city-stats { color: #666; }

        .feed-name { font-weight: 500; }
        .feed-count { color: #666; }
        .feed-count.zero { color: #d32f2f; }
        .feed-count.error { color: #d32f2f; font-size: 0.85em; }

        .sparkline {
            height: 30px;
            display: flex;
            align-items: flex-end;
            gap: 1px;
            margin: 8px 0 4px;
        }

        .sparkline .bar {
            flex: 1;
            min-width: 3px;
            max-width: 10px;
            background: #666;
            border-radius: 1px 1px 0 0;
        }

        .sparkline .bar.error { background: #d32f2f; }
        .sparkline .bar.zero { background: #f57c00; min-height: 2px; }

        .history-label { font-size: 0.75em; color: #999; }
        .feed-detail { padding-left: 20px; }
        .city-content { padding-left: 10px; }
    </style>
</head>
<body>
    <h1>Calendar Feed Health Report</h1>
    <div class="generated" id="generated">Loading...</div>

    <details class="anomalies" id="anomalies">
        <summary>Anomalies (<span id="anomaly-count">0</span>)</summary>
        <div id="anomaly-list">Loading...</div>
    </details>

    <div id="cities"></div>

    <script>
        async function loadReport() {
            try {
                const response = await fetch('report.json');
                if (!response.ok) throw new Error('Failed to load report');
                renderReport(await response.json());
            } catch (e) {
                document.getElementById('generated').textContent = 'Error: ' + e.message;
            }
        }

        function capitalize(s) {
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        function renderReport(data) {
            document.getElementById('generated').textContent =
                'Last updated: ' + new Date(data.generated).toLocaleString();

            const cityTotals = {};
            for (const [city, cityData] of Object.entries(data.cities || {})) {
                cityTotals[city] = Object.values(cityData.feeds || {}).reduce((sum, feed) => {
                    const latest = (feed.history || []).slice(-1)[0];
                    return sum + (latest && !latest.error ? latest.count : 0);
                }, 0);
            }

            const recentAnomalies = (data.anomalies || [])
                .sort((a, b) => b.date.localeCompare(a.date))
                .slice(0, 20);

            document.getElementById('anomaly-count').textContent = recentAnomalies.length;
            const anomalyList = document.getElementById('anomaly-list');
            if (recentAnomalies.length === 0) {
                anomalyList.innerHTML = '<div>No anomalies detected</div>';
            } else {
                anomalyList.innerHTML = recentAnomalies.map(a => `
                    <div class="anomaly ${a.severity}">
                        <strong>${a.feed}</strong>: ${a.message}
                        <div class="meta">${a.city} &bull; ${a.date}</div>
                    </div>
                `).join('');
            }

            const citiesContainer = document.getElementById('cities');
            citiesContainer.innerHTML = '';

            for (const [cityName, cityData] of Object.entries(data.cities || {})) {
                const feeds = Object.entries(cityData.feeds || {})
                    .sort((a, b) => {
                        const aCount = ((a[1].history || []).slice(-1)[0] || {}).count || 0;
                        const bCount = ((b[1].history || []).slice(-1)[0] || {}).count || 0;
                        return bCount - aCount;
                    });

                const total = cityTotals[cityName] || 0;

                const cityEl = document.createElement('details');
                cityEl.innerHTML = `
                    <summary><span class="city-name">${capitalize(cityName)}</span> <span class="city-stats">${total.toLocaleString()} events from ${feeds.length} feeds</span></summary>
                    <div class="city-content">
                        ${feeds.map(([name, feed]) => renderFeed(name, feed)).join('')}
                    </div>
                `;
                cityEl.addEventListener('toggle', () => {
                    cityEl.querySelectorAll('.city-content > details').forEach(d => d.open = cityEl.open);
                });
                citiesContainer.appendChild(cityEl);
            }
        }

        function renderFeed(name, feed) {
            const history = (feed.history || []).slice(-30);
            const latest = history[history.length - 1] || {};
            const maxCount = Math.max(...history.map(h => h.count || 0), 1);

            let countClass = '';
            let countText = `${latest.count || 0} events`;

            if (latest.error) {
                countClass = 'error';
                countText = `error: ${latest.error}`;
            } else if (latest.count === 0) {
                countClass = 'zero';
                countText = '0 events';
            }

            const sparkline = history.map(h => {
                const height = h.count ? Math.max(10, (h.count / maxCount) * 100) : 0;
                let barClass = '';
                if (h.error) barClass = 'error';
                else if (h.count === 0) barClass = 'zero';
                return `<div class="bar ${barClass}" style="height:${height}%" title="${h.date}: ${h.error || h.count + ' events'}"></div>`;
            }).join('');

            const range = history.length > 1
                ? `${history[0].date} to ${history[history.length-1].date}`
                : (history[0]?.date || 'No data');

            return `
                <details>
                    <summary><span class="feed-name">${name}</span> <span class="feed-count ${countClass}">${countText}</span></summary>
                    <div class="feed-detail">
                        <div class="sparkline">${sparkline}</div>
                        <div class="history-label">${range} (${history.length} days)</div>
                    </div>
                </details>
            `;
        }

        loadReport();
    </script>
</body>
</html>
