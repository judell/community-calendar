<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Feed Health Report</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.5;
            color: #333;
        }

        h1 { margin-bottom: 5px; }

        .generated {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .anomalies { margin-bottom: 20px; }

        .anomaly {
            padding: 8px 12px;
            margin: 6px 0;
            border-left: 3px solid;
            background: #fafafa;
        }

        .anomaly.high { border-color: #d32f2f; }
        .anomaly.medium { border-color: #f57c00; }
        .anomaly .meta { font-size: 0.85em; color: #666; }

        details { margin-bottom: 4px; }
        details > summary { cursor: pointer; padding: 4px 0; }
        details > summary > span { display: inline; }

        .city-name { font-weight: 600; text-transform: capitalize; }
        .city-stats { color: #666; }

        .feed-name { font-weight: 500; }
        .feed-count { color: #666; }
        .feed-count.zero { color: #d32f2f; }
        .feed-count.error { color: #d32f2f; font-size: 0.85em; }

        .sparkline {
            height: 30px;
            display: flex;
            align-items: flex-end;
            gap: 1px;
            margin: 8px 0 4px;
        }

        .sparkline .bar {
            flex: 1;
            min-width: 3px;
            max-width: 10px;
            background: #666;
            border-radius: 1px 1px 0 0;
        }

        .sparkline .bar.error { background: #d32f2f; }
        .sparkline .bar.zero { background: #f57c00; min-height: 2px; }

        .history-label { font-size: 0.75em; color: #999; }
        .feed-detail { padding-left: 20px; }
        .city-content { padding-left: 10px; }

        .url-section { margin-top: 30px; }
        .url-section h2 { margin-bottom: 10px; }
        .url-table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin: 8px 0; }
        .url-table th { text-align: left; padding: 4px 8px; border-bottom: 2px solid #ddd; }
        .url-table td { padding: 4px 8px; border-bottom: 1px solid #eee; }
        .url-table td.num { text-align: right; }
        .url-table tr.warn td { color: #d32f2f; }
        .url-table tr.caution td { color: #f57c00; }
        .url-table a { color: #1976d2; text-decoration: none; word-break: break-all; }
        .url-table a:hover { text-decoration: underline; }
        .url-summary { display: flex; gap: 20px; flex-wrap: wrap; margin: 8px 0; }
        .url-stat { background: #f5f5f5; padding: 8px 14px; border-radius: 6px; }
        .url-stat .label { font-size: 0.8em; color: #666; }
        .url-stat .value { font-size: 1.3em; font-weight: 600; }
        .pct-bar { display: inline-block; height: 8px; border-radius: 4px; vertical-align: middle; }
        .pct-bar.good { background: #4caf50; }
        .pct-bar.bad { background: #d32f2f; }
    </style>
</head>
<body>
    <h1>Calendar Feed Health Report</h1>
    <div class="generated" id="generated">Loading...</div>

    <details class="anomalies" id="anomalies">
        <summary>Anomalies (<span id="anomaly-count">0</span>)</summary>
        <div id="anomaly-list">Loading...</div>
    </details>

    <div id="cities"></div>

    <div class="url-section">
        <h2>URL Quality</h2>
        <div id="url-report">Loading...</div>
    </div>

    <script>
        async function loadReport() {
            try {
                const response = await fetch('report.json');
                if (!response.ok) throw new Error('Failed to load report');
                renderReport(await response.json());
            } catch (e) {
                document.getElementById('generated').textContent = 'Error: ' + e.message;
            }
        }

        function capitalize(s) {
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        function renderReport(data) {
            document.getElementById('generated').textContent =
                'Last updated: ' + new Date(data.generated).toLocaleString();

            const cityTotals = {};
            for (const [city, cityData] of Object.entries(data.cities || {})) {
                cityTotals[city] = Object.values(cityData.feeds || {}).reduce((sum, feed) => {
                    const latest = (feed.history || []).slice(-1)[0];
                    return sum + (latest && !latest.error ? latest.count : 0);
                }, 0);
            }

            const recentAnomalies = (data.anomalies || [])
                .sort((a, b) => b.date.localeCompare(a.date))
                .slice(0, 20);

            document.getElementById('anomaly-count').textContent = recentAnomalies.length;
            const anomalyList = document.getElementById('anomaly-list');
            if (recentAnomalies.length === 0) {
                anomalyList.innerHTML = '<div>No anomalies detected</div>';
            } else {
                anomalyList.innerHTML = recentAnomalies.map(a => `
                    <div class="anomaly ${a.severity}">
                        <strong>${a.feed}</strong>: ${a.message}
                        <div class="meta">${a.city} &bull; ${a.date}</div>
                    </div>
                `).join('');
            }

            const citiesContainer = document.getElementById('cities');
            citiesContainer.innerHTML = '';

            for (const [cityName, cityData] of Object.entries(data.cities || {})) {
                const feeds = Object.entries(cityData.feeds || {})
                    .sort((a, b) => {
                        const aCount = ((a[1].history || []).slice(-1)[0] || {}).count || 0;
                        const bCount = ((b[1].history || []).slice(-1)[0] || {}).count || 0;
                        return bCount - aCount;
                    });

                const total = cityTotals[cityName] || 0;

                const cityEl = document.createElement('details');
                cityEl.innerHTML = `
                    <summary><span class="city-name">${capitalize(cityName)}</span> <span class="city-stats">${total.toLocaleString()} events from ${feeds.length} feeds</span></summary>
                    <div class="city-content">
                        ${feeds.map(([name, feed]) => renderFeed(name, feed)).join('')}
                    </div>
                `;
                cityEl.addEventListener('toggle', () => {
                    cityEl.querySelectorAll('.city-content > details').forEach(d => d.open = cityEl.open);
                });
                citiesContainer.appendChild(cityEl);
            }

            renderUrlReport(data);
        }

        function renderFeed(name, feed) {
            const history = (feed.history || []).slice(-30);
            const latest = history[history.length - 1] || {};
            const maxCount = Math.max(...history.map(h => h.count || 0), 1);

            let countClass = '';
            let countText = `${latest.count || 0} events`;

            if (latest.error) {
                countClass = 'error';
                countText = `error: ${latest.error}`;
            } else if (latest.count === 0) {
                countClass = 'zero';
                countText = '0 events';
            }

            const sparkline = history.map(h => {
                const height = h.count ? Math.max(10, (h.count / maxCount) * 100) : 0;
                let barClass = '';
                if (h.error) barClass = 'error';
                else if (h.count === 0) barClass = 'zero';
                return `<div class="bar ${barClass}" style="height:${height}%" title="${h.date}: ${h.error || h.count + ' events'}"></div>`;
            }).join('');

            const range = history.length > 1
                ? `${history[0].date} to ${history[history.length-1].date}`
                : (history[0]?.date || 'No data');

            return `
                <details>
                    <summary><span class="feed-name">${name}</span> <span class="feed-count ${countClass}">${countText}</span></summary>
                    <div class="feed-detail">
                        <div class="sparkline">${sparkline}</div>
                        <div class="history-label">${range} (${history.length} days)</div>
                    </div>
                </details>
            `;
        }

        function renderUrlReport(data) {
            const container = document.getElementById('url-report');
            let html = '';
            for (const [cityName, cityData] of Object.entries(data.cities || {})) {
                const uq = cityData.url_quality;
                if (!uq) continue;

                const specificPct = uq.total_with_url > 0
                    ? Math.round((uq.total_with_url - uq.generic_count) / uq.total_with_url * 100) : 100;

                html += `
                    <details>
                        <summary><span class="city-name">${capitalize(cityName)}</span>
                            <span class="city-stats">${uq.total_events.toLocaleString()} events, ${uq.unique_urls.toLocaleString()} unique URLs, ${specificPct}% event-specific</span>
                        </summary>
                        <div class="city-content">
                            <div class="url-summary">
                                <div class="url-stat"><div class="label">Events with URL</div><div class="value">${uq.total_with_url.toLocaleString()} / ${uq.total_events.toLocaleString()}</div></div>
                                <div class="url-stat"><div class="label">Unique URLs</div><div class="value">${uq.unique_urls.toLocaleString()}</div></div>
                                <div class="url-stat"><div class="label">Generic URL events</div><div class="value" style="color:${uq.generic_count > 0 ? '#d32f2f' : '#4caf50'}">${uq.generic_count} (${100 - specificPct}%)</div></div>
                                <div class="url-stat"><div class="label">HTTP (not HTTPS)</div><div class="value" style="color:${uq.http_count > 0 ? '#f57c00' : '#4caf50'}">${uq.http_count} (${uq.http_domains} domains)</div></div>
                            </div>
                            ${uq.generic_domains.length ? `
                            <details>
                                <summary>Generic URLs (${uq.generic_domains.length} domains, ${uq.generic_count} events)</summary>
                                <table class="url-table">
                                    <tr><th>Domain</th><th>Events</th><th>URL</th></tr>
                                    ${uq.generic_domains.map(g => `
                                        <tr class="warn"><td>${g.domain}</td><td class="num">${g.events}</td><td><a href="${g.url}" target="_blank">${g.url.length > 60 ? g.url.substring(0, 60) + '...' : g.url}</a></td></tr>
                                    `).join('')}
                                </table>
                            </details>` : ''}
                            <details>
                                <summary>URL specificity by source</summary>
                                <table class="url-table">
                                    <tr><th>Source</th><th>Events</th><th>Unique URLs</th><th>Specificity</th></tr>
                                    ${(uq.source_specificity || []).map(r => `
                                        <tr class="${r.specificity_pct < 20 ? 'warn' : r.specificity_pct < 50 ? 'caution' : ''}">
                                            <td>${r.source}</td><td class="num">${r.events}</td><td class="num">${r.unique_urls}</td>
                                            <td><span class="pct-bar ${r.specificity_pct >= 80 ? 'good' : 'bad'}" style="width:${Math.max(4, r.specificity_pct * 0.6)}px"></span> ${r.specificity_pct}%</td>
                                        </tr>
                                    `).join('')}
                                </table>
                            </details>
                        </div>
                    </details>
                `;
            }
            if (!html) {
                container.innerHTML = '<div>No URL quality data available (next build will generate it)</div>';
                return;
            }
            container.innerHTML = html;
            container.querySelectorAll(':scope > details').forEach(cityEl => {
                cityEl.addEventListener('toggle', () => {
                    cityEl.querySelectorAll('.city-content > details').forEach(d => d.open = cityEl.open);
                });
            });
        }

        loadReport();
    </script>
</body>
</html>
