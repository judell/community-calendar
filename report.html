<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Feed Health Report</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.5;
            color: #333;
        }

        h1 { margin-bottom: 5px; }

        .generated {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .anomalies { margin-bottom: 20px; }

        .anomaly {
            padding: 8px 12px;
            margin: 6px 0;
            border-left: 3px solid;
            background: #fafafa;
        }

        .anomaly.high { border-color: #d32f2f; }
        .anomaly.medium { border-color: #f57c00; }
        .anomaly .meta { font-size: 0.85em; color: #666; }

        details { margin-bottom: 4px; }
        details > summary { cursor: pointer; padding: 4px 0; }
        details > summary > span { display: inline; }

        .city-name { font-weight: 600; text-transform: capitalize; }
        .city-stats { color: #666; }

        .feed-name { font-weight: 500; }
        .feed-count { color: #666; }
        .feed-count.zero { color: #d32f2f; }
        .feed-count.error { color: #d32f2f; font-size: 0.85em; }

        .sparkline {
            height: 30px;
            display: flex;
            align-items: flex-end;
            gap: 1px;
            margin: 8px 0 4px;
        }

        .sparkline .bar {
            flex: 1;
            min-width: 3px;
            max-width: 10px;
            background: #666;
            border-radius: 1px 1px 0 0;
        }

        .sparkline .bar.error { background: #d32f2f; }
        .sparkline .bar.zero { background: #f57c00; min-height: 2px; }

        .history-label { font-size: 0.75em; color: #999; }
        .feed-detail { padding-left: 20px; }
        .city-content { padding-left: 10px; }

        .url-section { margin-top: 30px; }
        .url-section h2 { margin-bottom: 10px; }
        .url-table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin: 8px 0; }
        .url-table th { text-align: left; padding: 4px 8px; border-bottom: 2px solid #ddd; }
        .url-table td { padding: 4px 8px; border-bottom: 1px solid #eee; }
        .url-table td.num { text-align: right; }
        .url-table tr.warn td { color: #d32f2f; }
        .url-table tr.caution td { color: #f57c00; }
        .url-table a { color: #1976d2; text-decoration: none; word-break: break-all; }
        .url-table a:hover { text-decoration: underline; }
        .url-summary { display: flex; gap: 20px; flex-wrap: wrap; margin: 8px 0; }
        .url-stat { background: #f5f5f5; padding: 8px 14px; border-radius: 6px; }
        .url-stat .label { font-size: 0.8em; color: #666; }
        .url-stat .value { font-size: 1.3em; font-weight: 600; }
        .pct-bar { display: inline-block; height: 8px; border-radius: 4px; vertical-align: middle; }
        .pct-bar.good { background: #4caf50; }
        .pct-bar.bad { background: #d32f2f; }
    </style>
</head>
<body>
    <h1>Calendar Feed Health Report</h1>
    <div class="generated" id="generated">Loading...</div>

    <details class="anomalies" id="anomalies">
        <summary>Anomalies (<span id="anomaly-count">0</span>)</summary>
        <div id="anomaly-list">Loading...</div>
    </details>

    <div id="cities"></div>

    <div class="url-section">
        <h2>URL Quality</h2>
        <div id="url-report">Loading...</div>
    </div>

    <script>
        const SUPABASE_URL = 'https://dzpdualvwspgqghrysyz.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_NnzobdoFNU39fjs84UNq8Q_X45oiMG5';

        async function supabaseQuery(query) {
            const res = await fetch(SUPABASE_URL + '/rest/v1/rpc/exec_sql', {
                method: 'POST',
                headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });
            if (!res.ok) throw new Error('Query failed: ' + res.status);
            return res.json();
        }

        async function loadUrlReport() {
            const container = document.getElementById('url-report');
            try {
                // Use PostgREST directly for each query
                const headers = { 'apikey': SUPABASE_KEY };

                // Get all events with URLs
                const eventsRes = await fetch(
                    SUPABASE_URL + '/rest/v1/events?select=city,url,source&url=not.is.null&url=neq.',
                    { headers }
                );
                if (!eventsRes.ok) throw new Error('Failed to fetch events');
                const events = await eventsRes.json();

                // Group by city
                const cities = {};
                for (const e of events) {
                    const city = e.city || '(none)';
                    if (!cities[city]) cities[city] = [];
                    cities[city].push(e);
                }

                let html = '';
                for (const [city, cityEvents] of Object.entries(cities).sort((a, b) => a[0].localeCompare(b[0]))) {
                    html += renderCityUrls(city, cityEvents);
                }
                container.innerHTML = html;
            } catch (e) {
                container.textContent = 'Error loading URL report: ' + e.message;
            }
        }

        function getDomain(url) {
            try { return new URL(url).hostname; } catch { return url; }
        }

        function renderCityUrls(city, events) {
            const total = events.length;
            const uniqueUrls = new Set(events.map(e => e.url)).size;

            // Find generic URLs: domains where all events share one URL
            const byDomain = {};
            for (const e of events) {
                const d = getDomain(e.url);
                if (!byDomain[d]) byDomain[d] = { urls: new Set(), count: 0 };
                byDomain[d].urls.add(e.url);
                byDomain[d].count++;
            }

            const genericDomains = [];
            let genericCount = 0;
            for (const [domain, info] of Object.entries(byDomain)) {
                if (info.urls.size === 1 && info.count > 5) {
                    genericDomains.push({ domain, events: info.count, url: [...info.urls][0] });
                    genericCount += info.count;
                }
            }
            genericDomains.sort((a, b) => b.events - a.events);

            // HTTP domains
            const httpDomains = new Set();
            let httpCount = 0;
            for (const e of events) {
                if (e.url.startsWith('http://')) {
                    httpDomains.add(getDomain(e.url));
                    httpCount++;
                }
            }

            // Source specificity
            const bySrc = {};
            for (const e of events) {
                const s = e.source || '(none)';
                if (!bySrc[s]) bySrc[s] = { count: 0, urls: new Set() };
                bySrc[s].count++;
                bySrc[s].urls.add(e.url);
            }
            const srcRows = Object.entries(bySrc)
                .map(([src, info]) => ({ source: src, events: info.count, unique: info.urls.size, pct: Math.round(info.urls.size / info.count * 100) }))
                .sort((a, b) => b.events - a.events)
                .slice(0, 15);

            const specificPct = Math.round((total - genericCount) / total * 100);

            return `
                <details>
                    <summary><span class="city-name">${capitalize(city)}</span>
                        <span class="city-stats">${total.toLocaleString()} events, ${uniqueUrls.toLocaleString()} unique URLs, ${specificPct}% event-specific</span>
                    </summary>
                    <div class="city-content">
                        <div class="url-summary">
                            <div class="url-stat"><div class="label">Events</div><div class="value">${total.toLocaleString()}</div></div>
                            <div class="url-stat"><div class="label">Unique URLs</div><div class="value">${uniqueUrls.toLocaleString()}</div></div>
                            <div class="url-stat"><div class="label">Generic URL events</div><div class="value" style="color:${genericCount > 0 ? '#d32f2f' : '#4caf50'}">${genericCount} (${100 - specificPct}%)</div></div>
                            <div class="url-stat"><div class="label">HTTP (not HTTPS)</div><div class="value" style="color:${httpCount > 0 ? '#f57c00' : '#4caf50'}">${httpCount} (${httpDomains.size} domains)</div></div>
                        </div>

                        ${genericDomains.length ? `
                        <details>
                            <summary>Generic URLs (${genericDomains.length} domains, ${genericCount} events)</summary>
                            <table class="url-table">
                                <tr><th>Domain</th><th>Events</th><th>URL</th></tr>
                                ${genericDomains.map(g => `
                                    <tr class="warn"><td>${g.domain}</td><td class="num">${g.events}</td><td><a href="${g.url}" target="_blank">${g.url.length > 60 ? g.url.substring(0, 60) + '...' : g.url}</a></td></tr>
                                `).join('')}
                            </table>
                        </details>` : ''}

                        <details>
                            <summary>URL specificity by source</summary>
                            <table class="url-table">
                                <tr><th>Source</th><th>Events</th><th>Unique URLs</th><th>Specificity</th></tr>
                                ${srcRows.map(r => `
                                    <tr class="${r.pct < 20 ? 'warn' : r.pct < 50 ? 'caution' : ''}">
                                        <td>${r.source}</td><td class="num">${r.events}</td><td class="num">${r.unique}</td>
                                        <td class="num"><span class="pct-bar ${r.pct >= 80 ? 'good' : 'bad'}" style="width:${Math.max(4, r.pct * 0.6)}px"></span> ${r.pct}%</td>
                                    </tr>
                                `).join('')}
                            </table>
                        </details>
                    </div>
                </details>
            `;
        }
    </script>

    <script>
        async function loadReport() {
            try {
                const response = await fetch('report.json');
                if (!response.ok) throw new Error('Failed to load report');
                renderReport(await response.json());
            } catch (e) {
                document.getElementById('generated').textContent = 'Error: ' + e.message;
            }
        }

        function capitalize(s) {
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        function renderReport(data) {
            document.getElementById('generated').textContent =
                'Last updated: ' + new Date(data.generated).toLocaleString();

            const cityTotals = {};
            for (const [city, cityData] of Object.entries(data.cities || {})) {
                cityTotals[city] = Object.values(cityData.feeds || {}).reduce((sum, feed) => {
                    const latest = (feed.history || []).slice(-1)[0];
                    return sum + (latest && !latest.error ? latest.count : 0);
                }, 0);
            }

            const recentAnomalies = (data.anomalies || [])
                .sort((a, b) => b.date.localeCompare(a.date))
                .slice(0, 20);

            document.getElementById('anomaly-count').textContent = recentAnomalies.length;
            const anomalyList = document.getElementById('anomaly-list');
            if (recentAnomalies.length === 0) {
                anomalyList.innerHTML = '<div>No anomalies detected</div>';
            } else {
                anomalyList.innerHTML = recentAnomalies.map(a => `
                    <div class="anomaly ${a.severity}">
                        <strong>${a.feed}</strong>: ${a.message}
                        <div class="meta">${a.city} &bull; ${a.date}</div>
                    </div>
                `).join('');
            }

            const citiesContainer = document.getElementById('cities');
            citiesContainer.innerHTML = '';

            for (const [cityName, cityData] of Object.entries(data.cities || {})) {
                const feeds = Object.entries(cityData.feeds || {})
                    .sort((a, b) => {
                        const aCount = ((a[1].history || []).slice(-1)[0] || {}).count || 0;
                        const bCount = ((b[1].history || []).slice(-1)[0] || {}).count || 0;
                        return bCount - aCount;
                    });

                const total = cityTotals[cityName] || 0;

                const cityEl = document.createElement('details');
                cityEl.innerHTML = `
                    <summary><span class="city-name">${capitalize(cityName)}</span> <span class="city-stats">${total.toLocaleString()} events from ${feeds.length} feeds</span></summary>
                    <div class="city-content">
                        ${feeds.map(([name, feed]) => renderFeed(name, feed)).join('')}
                    </div>
                `;
                cityEl.addEventListener('toggle', () => {
                    cityEl.querySelectorAll('.city-content > details').forEach(d => d.open = cityEl.open);
                });
                citiesContainer.appendChild(cityEl);
            }
        }

        function renderFeed(name, feed) {
            const history = (feed.history || []).slice(-30);
            const latest = history[history.length - 1] || {};
            const maxCount = Math.max(...history.map(h => h.count || 0), 1);

            let countClass = '';
            let countText = `${latest.count || 0} events`;

            if (latest.error) {
                countClass = 'error';
                countText = `error: ${latest.error}`;
            } else if (latest.count === 0) {
                countClass = 'zero';
                countText = '0 events';
            }

            const sparkline = history.map(h => {
                const height = h.count ? Math.max(10, (h.count / maxCount) * 100) : 0;
                let barClass = '';
                if (h.error) barClass = 'error';
                else if (h.count === 0) barClass = 'zero';
                return `<div class="bar ${barClass}" style="height:${height}%" title="${h.date}: ${h.error || h.count + ' events'}"></div>`;
            }).join('');

            const range = history.length > 1
                ? `${history[0].date} to ${history[history.length-1].date}`
                : (history[0]?.date || 'No data');

            return `
                <details>
                    <summary><span class="feed-name">${name}</span> <span class="feed-count ${countClass}">${countText}</span></summary>
                    <div class="feed-detail">
                        <div class="sparkline">${sparkline}</div>
                        <div class="history-label">${range} (${history.length} days)</div>
                    </div>
                </details>
            `;
        }

        loadReport();
        loadUrlReport();
    </script>
</body>
</html>
